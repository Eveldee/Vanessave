@page "/system-settings/skin-selector"
@using Vanessave.Nobeta
@using Vanessave.Utils
@using Humanizer
@using Vanessave.Services
@using Vanessave.Utils.Extensions
@inject IJSRuntime JS
@inject SaveCipherProvider SaveCipher
@inject ISnackbar Snackbar

<MudText Typo="Typo.h3" Class="mb-6">Skin Selector</MudText>

<SavePicker @ref="_savePicker" Label="Pick System Settings (System.dat)"/>

<pre><MudText>
<MudAlert Severity="Severity.Warning" Class="mt-4">A restart of the game is needed in order to apply the new selected skin.

The game will ignore any DLC skin if you don't posses the according DLC.</MudAlert>
</MudText></pre>

@if (_systemSettings is null)
{
    <MudDivider Class="my-4"/>

    <MudText>Load a system settings file first.</MudText>
}
else
{
    <MudPaper Outlined="true" Class="pa-4 mt-4" Style=" user-select: none;">
        <MudCarousel Class="mud-width-full" ItemsSource="@_source" @bind-SelectedIndex="_systemSettings.CurrentSkin" ShowArrows="true" ShowBullets="false" AutoCycle="false" Style="height: 550px;">
            <ItemTemplate>
                <div class="d-flex flex-column flex-column justify-center" style="height:100%;">
                    <MudImage Alt="Skin Preview" Src="@context.PreviewUri" Style="width: 400px;" Class="mx-auto"/>
                    <MudText Align="@Align.Center" Class="mx-auto">@context.SkinName</MudText>
                </div>
            </ItemTemplate>
        </MudCarousel>
        <MudPagination @bind-Selected:get="@(_systemSettings.CurrentSkin + 1)" @bind-Selected:set="@(index => _systemSettings.CurrentSkin = index - 1)" Count="@_source.Length" Class="pa-4 justify-center d-flex"/>

    </MudPaper>

    <div class="fab-download">
        <MudTooltip Text="Download modified settings">
            <MudFab Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Download" @onclick="DownloadSettings"/>
        </MudTooltip>
    </div>
}

@code {
    private SavePicker _savePicker = null!;
    private SystemSettings? _systemSettings;

    private readonly SkinInfo[] _source = Enum.GetValues<GameSkin>()
        .Select(skin => new SkinInfo(skin.Humanize(), $"/assets/skins/Skin_{skin.ToString()}.png"))
        .ToArray();

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _savePicker.OnSaveLoad += OnSaveLoad;
        }
    }

    private Task OnSaveLoad(string settings)
    {
        try
        {
            _systemSettings = JsonUtils.LoadSystemSettings(settings);

            StateHasChanged();
        }
        catch
        {
            Snackbar.AddError("Invalid System Settings file, make sure you load \"System.dat\".");
        }

        return Task.CompletedTask;
    }

    private async Task DownloadSettings()
    {
        if (_systemSettings is null)
        {
            return;
        }

        // Write new settings and download it
        var settingsText = JsonUtils.WriteSave(_systemSettings);

        await using var encryptedDataStream = SaveCipher.GetEncryptStream(settingsText);
        using var streamRef = new DotNetStreamReference(encryptedDataStream);

        await JS.InvokeVoidAsync("downloadFileFromStream", "System.dat", streamRef);
    }

    public void Dispose()
    {
        _savePicker.OnSaveLoad -= OnSaveLoad;
    }

    private record SkinInfo(string SkinName, string PreviewUri);

}